<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE åŒæ­¥è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .debug-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected { background: #10b981; }
        .status-connecting { background: #f59e0b; }
        .status-disconnected { background: #ef4444; }

        .log-container {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #2563eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ SSE åŒæ­¥è°ƒè¯•å·¥å…·</h1>

    <div class="debug-panel">
        <h3>è¿æ¥çŠ¶æ€</h3>
        <div id="connection-status">
            <span class="status-indicator status-disconnected"></span>
            <span>æœªè¿æ¥</span>
        </div>

        <div class="stats-grid" id="stats-container">
            <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <div style="margin-top: 15px;">
            <button onclick="startSSETest()">å¼€å§‹SSEæµ‹è¯•</button>
            <button onclick="stopSSETest()">åœæ­¢SSEæµ‹è¯•</button>
            <button onclick="showSyncStatus()">æ˜¾ç¤ºåŒæ­¥çŠ¶æ€</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="triggerManualSync()">æ‰‹åŠ¨è§¦å‘åŒæ­¥</button>
        </div>
    </div>

    <div class="debug-panel">
        <h3>å®æ—¶æ—¥å¿—</h3>
        <div id="log-output" class="log-container">
            ç­‰å¾…æ—¥å¿—è¾“å‡º...
        </div>
    </div>

    <div class="debug-panel">
        <h3>SSE æ¶ˆæ¯å†å²</h3>
        <div id="message-history" class="log-container">
            ç­‰å¾…SSEæ¶ˆæ¯...
        </div>
    </div>

    <script>
        // å¼•å…¥å¿…è¦çš„è„šæœ¬
        let authToken = localStorage.getItem('authToken');
        let testEventSource = null;
        let messageCount = 0;
        let connectionStartTime = null;

        // æ—¥å¿—è¾“å‡º
        const logContainer = document.getElementById('log-output');
        const messageHistory = document.getElementById('message-history');
        const statsContainer = document.getElementById('stats-container');
        const connectionStatus = document.getElementById('connection-status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;

            console.log(message);
        }

        function logMessage(message, data) {
            const timestamp = new Date().toLocaleTimeString();
            const msgEntry = `[${timestamp}] ${message}: ${JSON.stringify(data, null, 2)}\n`;
            messageHistory.textContent += msgEntry;
            messageHistory.scrollTop = messageHistory.scrollHeight;

            messageCount++;
            updateStats();
        }

        function updateConnectionStatus(status, text) {
            const indicator = connectionStatus.querySelector('.status-indicator');
            const statusText = connectionStatus.querySelector('span:last-child');

            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        function updateStats() {
            const uptime = connectionStartTime ? Math.floor((Date.now() - connectionStartTime) / 1000) : 0;
            const readyState = testEventSource ? testEventSource.readyState : EventSource.CLOSED;

            const stateNames = {
                [EventSource.CONNECTING]: 'è¿æ¥ä¸­',
                [EventSource.OPEN]: 'å·²è¿æ¥',
                [EventSource.CLOSED]: 'å·²å…³é—­'
            };

            statsContainer.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">è¿æ¥çŠ¶æ€</div>
                    <div class="stat-value">${stateNames[readyState] || 'æœªçŸ¥'}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">è¿æ¥æ—¶é•¿</div>
                    <div class="stat-value">${uptime} ç§’</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ¥æ”¶æ¶ˆæ¯æ•°</div>
                    <div class="stat-value">${messageCount}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">SSE æ”¯æŒ</div>
                    <div class="stat-value">${typeof EventSource !== 'undefined' ? 'æ˜¯' : 'å¦'}</div>
                </div>
            `;
        }

        function startSSETest() {
            if (!authToken) {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°è®¤è¯tokenï¼Œè¯·å…ˆç™»å½•', 'error');
                alert('è¯·å…ˆåœ¨ä¸»é¡µé¢ç™»å½•ï¼Œç„¶ååˆ·æ–°æ­¤é¡µé¢');
                return;
            }

            if (testEventSource) {
                log('âš ï¸ SSEè¿æ¥å·²å­˜åœ¨ï¼Œå…ˆåœæ­¢ç°æœ‰è¿æ¥');
                stopSSETest();
            }

            log('ğŸš€ å¼€å§‹SSEæµ‹è¯•è¿æ¥...');
            connectionStartTime = Date.now();

            const url = `/api/events?token=${encodeURIComponent(authToken)}`;
            testEventSource = new EventSource(url);

            testEventSource.onopen = function(event) {
                log('âœ… SSEè¿æ¥å·²å»ºç«‹');
                updateConnectionStatus('connected', 'å·²è¿æ¥');
                updateStats();
            };

            testEventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log(`ğŸ“¨ æ”¶åˆ°SSEæ¶ˆæ¯: ${data.type}`);
                    logMessage('SSEæ¶ˆæ¯', data);
                    updateStats();
                } catch (error) {
                    log(`âŒ è§£æSSEæ¶ˆæ¯å¤±è´¥: ${error.message}`);
                    logMessage('è§£æé”™è¯¯', { raw: event.data, error: error.message });
                }
            };

            testEventSource.onerror = function(event) {
                log('âŒ SSEè¿æ¥é”™è¯¯');
                updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
                logMessage('SSEé”™è¯¯', {
                    readyState: testEventSource.readyState,
                    event: event
                });
                updateStats();
            };

            // å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            setInterval(updateStats, 1000);
        }

        function stopSSETest() {
            if (testEventSource) {
                log('â¹ï¸ åœæ­¢SSEè¿æ¥...');
                testEventSource.close();
                testEventSource = null;
                updateConnectionStatus('disconnected', 'å·²æ–­å¼€');
                connectionStartTime = null;
                updateStats();
            } else {
                log('âš ï¸ æ²¡æœ‰æ´»è·ƒçš„SSEè¿æ¥');
            }
        }

        function clearLogs() {
            logContainer.textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
            messageHistory.textContent = 'æ¶ˆæ¯å†å²å·²æ¸…ç©º...\n';
            messageCount = 0;
            updateStats();
        }

        function triggerManualSync() {
            log('ğŸ”„ è§¦å‘æ‰‹åŠ¨åŒæ­¥æµ‹è¯•...');

            if (!authToken) {
                log('âŒ æ²¡æœ‰è®¤è¯token');
                return;
            }

            // æ¨¡æ‹Ÿæ•°æ®å˜åŒ–
            const testData = {
                categories: [],
                websites: [],
                settings: {},
                version: Date.now(),
                lastUpdated: new Date().toISOString()
            };

            fetch('/api/user-data/save', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log('âœ… æ‰‹åŠ¨åŒæ­¥æˆåŠŸï¼Œåº”è¯¥ä¼šè§¦å‘SSEå¹¿æ’­');
                } else {
                    log(`âŒ æ‰‹åŠ¨åŒæ­¥å¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                log(`âŒ æ‰‹åŠ¨åŒæ­¥è¯·æ±‚å¤±è´¥: ${error.message}`);
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“‹ SSEè°ƒè¯•å·¥å…·å·²åŠ è½½');
            log(`ğŸ”‘ è®¤è¯çŠ¶æ€: ${authToken ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`);
            log(`ğŸŒ EventSourceæ”¯æŒ: ${typeof EventSource !== 'undefined' ? 'æ˜¯' : 'å¦'}`);

            updateStats();

            if (!authToken) {
                log('âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è®¤è¯tokenï¼Œè¯·å…ˆåœ¨ä¸»é¡µé¢ç™»å½•');
            }
        });

        // æ¨¡æ‹ŸshowSyncStatuså‡½æ•°ï¼ˆå¦‚æœåœ¨ä¸»é¡µé¢ï¼Œå¯ä»¥è°ƒç”¨çœŸå®çš„ï¼‰
        function showSyncStatus() {
            log('ğŸ” åŒæ­¥çŠ¶æ€æ£€æŸ¥...');

            if (typeof getSyncStatus === 'function') {
                const status = getSyncStatus();
                log(`ğŸ“Š åŒæ­¥çŠ¶æ€: ${JSON.stringify(status, null, 2)}`);
            } else {
                log('âš ï¸ getSyncStatuså‡½æ•°ä¸å¯ç”¨ï¼ˆéœ€è¦åœ¨ä¸»é¡µé¢è°ƒç”¨ï¼‰');
                log('ğŸ” å½“å‰æµ‹è¯•çŠ¶æ€:');
                log(`  - EventSourceæ”¯æŒ: ${typeof EventSource !== 'undefined'}`);
                log(`  - æµ‹è¯•è¿æ¥çŠ¶æ€: ${testEventSource ? 'å·²å»ºç«‹' : 'æœªå»ºç«‹'}`);
                log(`  - è®¤è¯token: ${authToken ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
            }
        }
    </script>
</body>
</html>
